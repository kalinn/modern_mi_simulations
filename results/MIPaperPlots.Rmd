---
title: "MI Paper Plots"
author: "Kylie Getz and Kristin Linn"
date: "5/21/2022"
output: pdf_document
---

Results using 500 simulations, 10 MI
trueTreatment approx -0.69, trueEcog appox 0.4

os1 <- coxph(Surv(cmonth, dead) ~ treat + genderf +  
reth_black + reth_hisp + reth_oth + practypec + b.ecogvalue + smokey +  dgradeh + surgery + site_ureter + site_renal + site_urethra + age + var1 + var2, data=sdat.c, x=T)


```{r echo=F, include=F}
library(ggplot2)
library(gridExtra)
library(grid)
library(xtable)
library(kableExtra)
library(dplyr)
library(reshape2)

rootdir = "~/Box Sync/Mentoring/Students/Getz_Kylie/results"
fdir = file.path (rootdir, "2022_05_22")

getDfs <- function (mdm, pc){
  # Oracle, CC, MICE, and RF
  avgName = paste0 ("Avgs_", mdm, "_", pc, ".csv")
  percName = paste0 ("Percentiles_", mdm, "_", pc, ".csv")
  avgDf = read.csv (file.path (fdir, avgName))
  percDf = read.csv (file.path (fdir, percName))
  percDf$X = avgDf$X
  # AE
  avgName = paste0 ("AE", avgName)  
  percName = paste0 ("AE", percName)  
  aeAvg =  read.csv (file.path (fdir, avgName))
  colnames (aeAvg) = c ("X", "biasAE", "seAE", "coverageAE", "mseAE")
  aePerc =  read.csv (file.path (fdir, percName))
  colnames (aePerc) = c ("X", "percAELower", "percAEMid", "percAEUpper")
  aeAvg$X = avgDf$X
  aePerc$X = percDf$X
  avgDf = left_join (avgDf, aeAvg, by='X')
  percDf = left_join (percDf, aePerc, by='X')
  
  newdf = select (percDf, X, percOracleLower, percOracleMid, percOracleUpper)
  newdf$method = 'ORACLE'
  colnames (newdf)[2:4] = c ("Lower", "Median", "Upper")
  oracle = newdf
  
  newdf = select (percDf, X, percCCLower, percCCMid, percCCUpper)
  newdf$method = 'CC'
  colnames (newdf)[2:4] = c ("Lower", "Median", "Upper")
  cc = newdf

  newdf = select (percDf, X, percMICELower, percMICEMid, percMICEUpper)
  newdf$method = 'MICE'
  colnames (newdf)[2:4] = c ("Lower", "Median", "Upper")
  mice = newdf

  newdf = select (percDf, X, percRFLower, percRFMid, percRFUpper)
  newdf$method = 'RF'
  colnames (newdf)[2:4] = c ("Lower", "Median", "Upper")
  rf = newdf
  
  newdf = select (percDf, X, percAELower, percAEMid, percAEUpper)
  newdf$method = 'DAE'
  colnames (newdf)[2:4] = c ("Lower", "Median", "Upper")
  dae = newdf
  
  final = rbind (oracle, cc, mice, rf, dae)
  final$mech = mdm
  final$prop = pc
  return (list ('avg'=avgDf, 'perc'=final))
}

MCAR10 = getDfs ('MCAR', 10)
MCAR30 = getDfs ('MCAR', 30)
MCAR50 = getDfs ('MCAR', 50)
MCAR = rbind (MCAR10$perc, MCAR30$perc, MCAR50$perc)

MAR10 = getDfs ('MAR', 10)
MAR30 = getDfs ('MAR', 30)
MAR50 = getDfs ('MAR', 50)
MAR = rbind (MAR10$perc, MAR30$perc, MAR50$perc)

MNAR10a = getDfs ('MNAR1', 10)
MNAR30a = getDfs ('MNAR1', 30)
MNAR50a = getDfs ('MNAR1', 50)
MNAR1 = rbind (MNAR10a$perc, MNAR30a$perc, MNAR50a$perc)

MNAR10b = getDfs ('MNAR2', 10)
MNAR30b = getDfs ('MNAR2', 30)
MNAR50b = getDfs ('MNAR2', 50)
MNAR2 = rbind (MNAR10b$perc, MNAR30b$perc, MNAR50b$perc)

allData = rbind (MCAR, MAR, MNAR1, MNAR2)
```

```{r echo=F, include=F}

mycols = c ("#D55E00", "#E69F00", "#2271B2", "#3DB7E9", "#359B73")

plotOne <- function (data, mdm){
  data$mech = factor (data$mech)
  data$method = factor (data$method, levels=c("ORACLE", "CC", "MICE", "RF", "DAE"))
  dat = dplyr::filter (data, mech==mdm)
  datOracle = filter (dat, method=='ORACLE' & prop==10)
  dat = filter (dat, !(method=='ORACLE'))
  datOracle$prop = ""
  fdat = rbind (datOracle, dat)
  gg = ggplot(fdat, aes(x=method, y=Median, color=method)) + 
    ylab("Estimate - True") +
    xlab("") +
    geom_errorbar(aes(ymax = Upper, ymin = Lower), position = "dodge",size = 1.5) +
    geom_hline(yintercept=0, linetype="dashed", color="black") +
    geom_point(shape=16,colour="black",size=2) +
    facet_grid(cols=vars(prop), scales = "free_x", space="free_x", switch="both") +
    theme(panel.spacing = unit(1, "lines"),
         strip.background = element_blank(),
         axis.line = element_line(colour = "grey"),
         panel.grid.major.y = element_line(colour = "grey"),
         strip.placement = "outside",
         axis.text.x = element_text(angle = 45, hjust = 1,size=10),
         panel.background = element_rect(fill = 'white', colour = 'white')) +
#    scale_x_discrete(breaks=c("CC","MICE","RF","DAE","ORACLE")) + 
    theme(legend.position = 'none') +
    scale_color_manual(values=mycols)
  return (gg)
}


percPlot = function (data, variable){
  red = filter (data, X==variable)
  mcar = plotOne (red, mdm='MCAR')
  mar = plotOne (red, mdm='MAR')
  mnar1 = plotOne (red, mdm='MNAR1')
  mnar2 = plotOne (red, mdm='MNAR2')
  op = grid.arrange(mcar, mar, mnar1, mnar2, nrow = 2)
  return (op)
}

```

\newpage

# treat

```{r echo=F}
percPlot(allData, 'treat')
```

\newpage

# genderf

```{r echo=F}
percPlot(allData, 'genderf')
```

\newpage

# reth_black

```{r echo=F}
percPlot(allData, 'reth_black')
```

\newpage

# reth_hisp

```{r echo=F}
percPlot(allData, 'reth_hisp')
```

\newpage

# reth_oth

```{r echo=F}
percPlot(allData, 'reth_oth')
```

\newpage

# practypec

```{r echo=F}
percPlot(allData, 'practypec')
```

\newpage

# b.ecogvalue

```{r echo=F}
percPlot(allData, 'b.ecogvalue')
```

\newpage

# smokey

```{r echo=F}
percPlot(allData, 'smokey')
```

\newpage

# dgradeh

```{r echo=F}
percPlot(allData, 'dgradeh')
```

\newpage

# surgery

```{r echo=F}
percPlot(allData, 'surgery')
```

\newpage

# site_ureter

```{r echo=F}
percPlot(allData, 'site_ureter')
```

\newpage

# site_renal

```{r echo=F}
percPlot(allData, 'site_renal')
```

\newpage

# site_urethra

```{r echo=F}
percPlot(allData, 'site_urethra')
```

\newpage

# age

```{r echo=F}
percPlot(allData, 'age')
```

\newpage

# var1

```{r echo=F}
percPlot(allData, 'var1')
```

\newpage

# var2
```{r echo=F}
percPlot(allData, 'var2')
```

